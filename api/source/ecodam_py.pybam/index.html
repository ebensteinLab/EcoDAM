<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>ecodam_py.pybam - EcoDAM</title>
        <link href="../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <link href="//use.fontawesome.com/releases/v5.8.1/css/all.css" rel="stylesheet">
        <link href="//use.fontawesome.com/releases/v5.8.1/css/v4-shims.css" rel="stylesheet">
        <link href="../../../css/mkapi-common.css" rel="stylesheet">
        <link href="../../../css/mkapi-mkdocs.css" rel="stylesheet">

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../..">EcoDAM</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../BedGraphAccessor/" class="dropdown-item">BedGraphAccessor</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">API <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">ecodam_py</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../ecodam_py/" class="dropdown-item">ecodam_py</a>
</li>
            
<li>
    <a href="../../ecodam_py.bedgraph/" class="dropdown-item">ecodam_py.bedgraph</a>
</li>
            
<li>
    <a href="../../ecodam_py.parse_gene_coding/" class="dropdown-item">ecodam_py.parse_gene_coding</a>
</li>
            
<li>
    <a href="../../ecodam_py.compare_ecodam_atac/" class="dropdown-item">ecodam_py.compare_ecodam_atac</a>
</li>
            
<li>
    <a href="../../ecodam_py.peak_calling/" class="dropdown-item">ecodam_py.peak_calling</a>
</li>
            
<li>
    <a href="../../ecodam_py.eco_atac_normalization/" class="dropdown-item">ecodam_py.eco_atac_normalization</a>
</li>
            
<li>
    <a href="../../ecodam_py.pybam/" class="dropdown-item">ecodam_py.pybam</a>
</li>
            
<li>
    <a href="../../ecodam_py.ml_pipeline/" class="dropdown-item">ecodam_py.ml_pipeline</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../../tools/" class="nav-link">Tools</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../notebooks/" class="nav-link">Notebooks</a>
                            </li>
                            <li class="navitem">
                                <a href="../../../about/" class="nav-link">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a href="https://github.com/ebensteinLab/EcoDAM/edit/master/docs/api/source/ecodam_py.pybam.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#ecodam_pypybam" class="nav-link">ecodam_py.pybam</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<div class="mkapi-node">
<h1 id="" class="mkapi-object mkapi-object-code plain">
<span class="mkapi-object-kind mkapi-object-kind-code">SOURCE CODE</span>
<span class="mkapi-object-prefix">ecodam_py.</span><span class="mkapi-object-name">pybam</span>
<span id="ecodam_py.pybam"></span><a class="mkapi-docs-link" href="../../ecodam_py.pybam">DOCS</a>
</h1>

<div class="mkapi-code">
<div class="codehilite"><pre><span></span><code><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Awesome people who have directly contributed to the project:</span>
<span class="sd">Jon Palmer - Bug finder &amp; advice on project direction</span>
<span class="sd">Mahmut Uludag - Bug finder</span>

<span class="sd">Help:       print pybam.wat</span>
<span class="sd">Github:     http://github.com/JohnLonginotto/pybam</span>

<span class="sd">This code was written by John Longinotto, a PhD student of the Pospisilik Lab at the Max Planck Institute of Immunbiology &amp; Epigenetics, Freiburg.</span>
<span class="sd">My PhD is funded by the Deutsches Epigenom Programm (DEEP), and the Max Planck IMPRS Program.</span>
<span class="sd">I study Adipose Biology and Circadian Rhythm in mice, although it seems these days I spend most of my time at the computer :-)</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">zlib</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">array</span> <span class="kn">import</span> <span class="n">array</span>
<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">unpack</span>

<span class="n">CtoPy</span>       <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span><span class="s1">&#39;&lt;c&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span><span class="s1">&#39;&lt;b&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span><span class="s1">&#39;&lt;B&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span><span class="s1">&#39;&lt;h&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span><span class="s1">&#39;&lt;H&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span><span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span><span class="s1">&#39;&lt;f&#39;</span> <span class="p">}</span>
<span class="n">py4py</span>       <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>  <span class="mi">1</span> <span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>  <span class="mi">1</span> <span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span>  <span class="mi">1</span> <span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>  <span class="mi">2</span> <span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>  <span class="mi">2</span> <span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span>  <span class="mi">4</span> <span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>  <span class="mi">4</span> <span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>  <span class="mi">4</span>  <span class="p">}</span>
<span class="n">dna_codes</span>   <span class="o">=</span> <span class="s1">&#39;=ACMGRSVTWYHKDBN&#39;</span>
<span class="n">cigar_codes</span> <span class="o">=</span> <span class="s1">&#39;MIDNSHP=X&#39;</span>
<span class="n">parse_codes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;sam&#39;</span><span class="p">:</span>                     <span class="s1">&#39; The current alignment in SAM format.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bam&#39;</span><span class="p">:</span>                     <span class="s1">&#39; All the bytes that make up the current alignment (&quot;read&quot;),</span><span class="se">\n</span><span class="s1">                              still in binary just as it was in the BAM file. Useful</span><span class="se">\n</span><span class="s1">                              when creating a new BAM file of filtered alignments.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_qname&#39;</span><span class="p">:</span>               <span class="s1">&#39; [1st column in SAM] The QNAME (fragment ID) of the alignment.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bam_qname&#39;</span><span class="p">:</span>               <span class="s1">&#39; The original bytes before decoding to sam_qname.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_flag&#39;</span><span class="p">:</span>                <span class="s1">&#39; [2nd column in SAM] The FLAG number of the alignment.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bam_flag&#39;</span><span class="p">:</span>                <span class="s1">&#39; The original bytes before decoding to sam_flag.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_refID&#39;</span><span class="p">:</span>               <span class="s1">&#39; The chromosome ID (not the same as the name!).</span><span class="se">\n</span><span class="s1">                              Chromosome names are stored in the BAM header (file_chromosomes),</span><span class="se">\n</span><span class="s1">                              so to convert refIDs to chromsome names one needs to do:</span><span class="se">\n</span><span class="s1">                              &quot;my_bam.file_chromosomes[read.sam_refID]&quot; (or use sam_rname)</span><span class="se">\n</span><span class="s1">                              But for comparisons, using the refID is much faster that using</span><span class="se">\n</span><span class="s1">                              the actual chromosome name (for example, when reading through a</span><span class="se">\n</span><span class="s1">                              sorted BAM file and looking for where last_refID != this_refID)</span><span class="se">\n</span><span class="s1">                              Note that when negative the alignment is not aligned, and thus one</span><span class="se">\n</span><span class="s1">                              must not perform my_bam.file_chromosomes[read.sam_refID]</span><span class="se">\n</span><span class="s1">                              without checking that the value is positive first.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_rname&#39;</span><span class="p">:</span>               <span class="s1">&#39; [3rd column in SAM] The actual chromosome/contig name for the</span><span class="se">\n</span><span class="s1">                              alignment. Will return &quot;*&quot; if refID is negative.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bam_refID&#39;</span><span class="p">:</span>               <span class="s1">&#39; The original bytes before decoding to sam_refID.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_pos1&#39;</span><span class="p">:</span>                <span class="s1">&#39; [4th column in SAM] The 1-based position of the alignment. Note</span><span class="se">\n</span><span class="s1">                              that in SAM format values less than 1 are converted to &quot;0&quot; for</span><span class="se">\n</span><span class="s1">                              &quot;no data&quot; and sam_pos1 will also do this.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_pos0&#39;</span><span class="p">:</span>                <span class="s1">&#39; The 0-based position of the alignment. Note that in SAM all</span><span class="se">\n</span><span class="s1">                              positions are 1-based, but in BAM they are stored as 0-based.</span><span class="se">\n</span><span class="s1">                              Unlike sam_pos1, negative values are kept as negative values,</span><span class="se">\n</span><span class="s1">                              essentially giving one the decoded value as it was stored.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bam_pos&#39;</span><span class="p">:</span>                 <span class="s1">&#39; The original bytes before decoding to sam_pos*.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_mapq&#39;</span><span class="p">:</span>                <span class="s1">&#39; [5th column in SAM] The Mapping Quality of the current alignment.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bam_mapq&#39;</span><span class="p">:</span>                <span class="s1">&#39; The original bytes before decoding to sam_mapq.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_cigar_string&#39;</span><span class="p">:</span>        <span class="s1">&#39; [6th column in SAM] The CIGAR string, as per the SAM format.</span><span class="se">\n</span><span class="s1">                              Allowed values are &quot;MIDNSHP=X&quot;.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_cigar_list&#39;</span><span class="p">:</span>          <span class="s1">&#39; A list of tuples with 2 values per tuple:</span><span class="se">\n</span><span class="s1">                              the number of bases, and the CIGAR operation applied to those</span><span class="se">\n</span><span class="s1">                              bases. Faster to calculate than sam_cigar_string.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bam_cigar&#39;</span><span class="p">:</span>               <span class="s1">&#39; The original bytes before decoding to sam_cigar_*.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_next_refID&#39;</span><span class="p">:</span>          <span class="s1">&#39; The sam_refID of the alignment</span><span class="se">\&#39;</span><span class="s1">s mate (if any). Note that as per</span><span class="se">\n</span><span class="s1">                              sam_refID, this value can be negative and is not the actual</span><span class="se">\n</span><span class="s1">                              chromosome name (see sam_pnext1).&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_rnext&#39;</span><span class="p">:</span>               <span class="s1">&#39; [7th column in SAM] The chromosome name of the alignment</span><span class="se">\&#39;</span><span class="s1">s mate.</span><span class="se">\n</span><span class="s1">                              Value is &quot;*&quot; if unmapped. Note that in a SAM file this value</span><span class="se">\n</span><span class="s1">                              is &quot;=&quot; if it is the same as the sam_rname, however pybam will</span><span class="se">\n</span><span class="s1">                              only do this if the user prints the whole SAM entry with &quot;sam&quot;.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bam_next_refID&#39;</span><span class="p">:</span>          <span class="s1">&#39; The original bytes before decoding to sam_next_refID.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_pnext1&#39;</span><span class="p">:</span>              <span class="s1">&#39; [8th column in SAM] The 1-based position of the alignment</span><span class="se">\&#39;</span><span class="s1">s mate.</span><span class="se">\n</span><span class="s1">                              Note that in SAM format values less than 1 are converted to &quot;0&quot;</span><span class="se">\n</span><span class="s1">                              for &quot;no data&quot;, and sam_pnext1 will also do this.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_pnext0&#39;</span><span class="p">:</span>              <span class="s1">&#39; The 0-based position of the alignment</span><span class="se">\&#39;</span><span class="s1">s mate. Note that in SAM all</span><span class="se">\n</span><span class="s1">                              positions are 1-based, but in BAM they are stored as 0-based.</span><span class="se">\n</span><span class="s1">                              Unlike sam_pnext1, negative values are kept as negative values</span><span class="se">\n</span><span class="s1">                              here, essentially giving you the value as it was stored in BAM.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bam_pnext&#39;</span><span class="p">:</span>               <span class="s1">&#39; The original bytes before decoding to sam_pnext0.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_tlen&#39;</span><span class="p">:</span>                <span class="s1">&#39; [9th column in SAM] The TLEN value.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bam_tlen&#39;</span><span class="p">:</span>                <span class="s1">&#39; The original bytes before decoding to sam_tlen.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_seq&#39;</span><span class="p">:</span>                 <span class="s1">&#39; [10th column in SAM] The SEQ value (DNA sequence of the alignment).</span><span class="se">\n</span><span class="s1">                              Allowed values are &quot;ACGTMRSVWYHKDBN and =&quot;.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bam_seq&#39;</span><span class="p">:</span>                 <span class="s1">&#39; The original bytes before decoding to sam_seq.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_qual&#39;</span><span class="p">:</span>                <span class="s1">&#39; [11th column in SAM] The QUAL value (quality scores per DNA base</span><span class="se">\n</span><span class="s1">                              in SEQ) of the alignment.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bam_qual&#39;</span><span class="p">:</span>                <span class="s1">&#39; The original bytes before decoding to sam_qual.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_tags_list&#39;</span><span class="p">:</span>           <span class="s1">&#39; A list of tuples with 3 values per tuple: a two-letter TAG ID, the</span><span class="se">\n</span><span class="s1">                              type code used to describe the data in the TAG value (see SAM spec.</span><span class="se">\n</span><span class="s1">                              for details), and the value of the TAG. Note that the BAM format</span><span class="se">\n</span><span class="s1">                              has type codes like &quot;c&quot; for a number in the range -127 to +127,</span><span class="se">\n</span><span class="s1">                              and &quot;C&quot; for a number in the range of 0 to 255.</span><span class="se">\n</span><span class="s1">                              In a SAM file however, all numerical codes appear to just be stored</span><span class="se">\n</span><span class="s1">                              using &quot;i&quot;, which is a number in the range -2147483647 to +2147483647.</span><span class="se">\n</span><span class="s1">                              sam_tags_list will therefore return the code used in the BAM file,</span><span class="se">\n</span><span class="s1">                              and not &quot;i&quot; for all numbers.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_tags_string&#39;</span><span class="p">:</span>         <span class="s1">&#39; [12th column a SAM] Returns the TAGs in the same format as would be found </span><span class="se">\n</span><span class="s1">                              in a SAM file (with all numbers having a signed 32bit code of &quot;i&quot;).&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bam_tags&#39;</span><span class="p">:</span>                <span class="s1">&#39; The original bytes before decoding to sam_tags_*.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_bin&#39;</span><span class="p">:</span>                 <span class="s1">&#39; The bin value of the alignment (used for indexing reads).</span><span class="se">\n</span><span class="s1">                              Please refer to section 5.3 of the SAM spec for how this</span><span class="se">\n</span><span class="s1">                              value is calculated.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bam_bin&#39;</span><span class="p">:</span>                 <span class="s1">&#39; The original bytes before decoding to sam_bin.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_block_size&#39;</span><span class="p">:</span>          <span class="s1">&#39; The number of bytes the current alignment takes up in the BAM</span><span class="se">\n</span><span class="s1">                              file minus the four bytes used to store the block_size value</span><span class="se">\n</span><span class="s1">                              itself. Essentially sam_block_size +4 == bytes needed to store</span><span class="se">\n</span><span class="s1">                              the current alignment.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bam_block_size&#39;</span><span class="p">:</span>          <span class="s1">&#39; The original bytes before decoding to sam_block_size.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_l_read_name&#39;</span><span class="p">:</span>         <span class="s1">&#39; The length of the QNAME plus 1 because the QNAME is terminated</span><span class="se">\n</span><span class="s1">                              with a NUL byte.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bam_l_read_name&#39;</span><span class="p">:</span>         <span class="s1">&#39; The original bytes before decoding to sam_l_read_name.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_l_seq&#39;</span><span class="p">:</span>               <span class="s1">&#39; The number of bases in the seq. Useful if you just want to know</span><span class="se">\n</span><span class="s1">                              how many bases are in the SEQ but do not need to know what those</span><span class="se">\n</span><span class="s1">                              bases are (which requires more decoding effort).&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bam_l_seq&#39;</span><span class="p">:</span>               <span class="s1">&#39; The original bytes before decoding to sam_l_seq.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sam_n_cigar_op&#39;</span><span class="p">:</span>          <span class="s1">&#39; The number of CIGAR operations in the CIGAR field. Useful if one</span><span class="se">\n</span><span class="s1">                              wants to know how many CIGAR operations there are, but does not</span><span class="se">\n</span><span class="s1">                              need to know what they are.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bam_n_cigar_op&#39;</span><span class="p">:</span>          <span class="s1">&#39; The original bytes before decoding to sam_n_cigar_op.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;file_alignments_read&#39;</span><span class="p">:</span>    <span class="s1">&#39; A running counter of the number of alignments (&quot;reads&quot;),</span><span class="se">\n</span><span class="s1">                              processed thus far. Note the BAM format does not store</span><span class="se">\n</span><span class="s1">                              how many reads are in a file, so the usefulness of this</span><span class="se">\n</span><span class="s1">                              metric is somewhat limited unless one already knows how</span><span class="se">\n</span><span class="s1">                              many reads are in the file.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;file_binary_header&#39;</span><span class="p">:</span>      <span class="s1">&#39; From the first byte in the file, until the first byte of</span><span class="se">\n</span><span class="s1">                              the first read. The original binary header.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;file_bytes_read&#39;</span><span class="p">:</span>         <span class="s1">&#39; A running counter of the bytes read from the file. Note</span><span class="se">\n</span><span class="s1">                              that as data is read in arbitary chunks, this is literally</span><span class="se">\n</span><span class="s1">                              the amount of data read from the file/pipe by pybam.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;file_chromosome_lengths&#39;</span><span class="p">:</span> <span class="s1">&#39; The binary header of the BAM file includes chromosome names</span><span class="se">\n</span><span class="s1">                              and chromosome lengths. This is a dictionary of chromosome-name</span><span class="se">\n</span><span class="s1">                              keys and chromosome-length values.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;file_chromosomes&#39;</span><span class="p">:</span>        <span class="s1">&#39; A list of chromosomes from the binary header.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;file_decompressor&#39;</span><span class="p">:</span>       <span class="s1">&#39; BAM files are compressed with bgzip. The value here reflects</span><span class="se">\n</span><span class="s1">                              the decompressor used. &quot;internal&quot; if pybam</span><span class="se">\&#39;</span><span class="s1">s internal</span><span class="se">\n</span><span class="s1">                              decompressor is being used, &quot;gzip&quot; or &quot;pigz&quot; if the system</span><span class="se">\n</span><span class="s1">                              has these binaries installed and pybam can find them.</span><span class="se">\n</span><span class="s1">                              Any other value reflects a custom decompression command.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;file_directory&#39;</span><span class="p">:</span>          <span class="s1">&#39; The directory the input BAM file can be found in. This will be</span><span class="se">\n</span><span class="s1">                              correct if the input file is specified via a string or python</span><span class="se">\n</span><span class="s1">                              file object, however if the input is a pipe such as sys.stdin, </span><span class="se">\n</span><span class="s1">                              then the current working directory will be used.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;file_header&#39;</span><span class="p">:</span>             <span class="s1">&#39; The ASCII portion of the BAM header. This is the typical header</span><span class="se">\n</span><span class="s1">                              users of samtools will be familiar with.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;file_name&#39;</span><span class="p">:</span>               <span class="s1">&#39; The file name (base name) of input file if input is a string or</span><span class="se">\n</span><span class="s1">                              python file object. If input is via stdin this will be &quot;&lt;stdin&gt;&quot;&#39;</span>
<span class="p">}</span>

<span class="n">wat</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">Main class: pybam.read</span>
<span class="s1">Github:     http://github.com/JohnLonginotto/pybam</span>

<span class="s1">[ Dynamic Parser Example ]</span>
<span class="s1">  for alignment in pybam.read(&#39;/my/data.bam&#39;):</span>
<span class="s1">      print alignment.sam_seq</span>

<span class="s1">[ Static Parser Example ]</span>
<span class="s1">  for seq,mapq in pybam.read(&#39;/my/data.bam&#39;,[&#39;sam_seq&#39;,&#39;sam_mapq&#39;]):</span>
<span class="s1">       print seq</span>
<span class="s1">       print mapq</span>

<span class="s1">[ Mixed Parser Example ]</span>
<span class="s1">  my_bam = pybam.read(&#39;/my/data.bam&#39;,[&#39;sam_seq&#39;,&#39;sam_mapq&#39;])</span>
<span class="s1">  print my_bam._static_parser_code</span>
<span class="s1">  for seq,mapq in my_bam:</span>
<span class="s1">       if seq.startswith(&#39;ACGT&#39;) and mapq &gt; 10:</span>
<span class="s1">       print my_bam.sam</span>

<span class="s1">[ Custom Decompressor (from file path) Example ]</span>
<span class="s1">  my_bam = pybam.read(&#39;/my/data.bam.lzma&#39;,decompressor=&#39;lzma --decompress --stdout /my/data.bam.lzma&#39;)</span>

<span class="s1">[ Custom Decompressor (from file object) Example ]</span>
<span class="s1">  my_bam = pybam.read(sys.stdin,decompressor=&#39;lzma --decompress --stdout&#39;) # data given to lzma via stdin</span>

<span class="s1">[ Force Internal bgzip Decompressor ]</span>
<span class="s1">  my_bam = pybam.read(&#39;/my/data.bam&#39;,decompressor=&#39;internal&#39;)</span>

<span class="s1">[ Parse Words (hah) ]&#39;&#39;&#39;</span>
<span class="n">wat</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">===============================================================================================</span><span class="se">\n\n</span><span class="s1">  &#39;</span> <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="s1">&#39;file_alignments_read&#39;</span> <span class="ow">or</span> <span class="n">code</span> <span class="ow">is</span> <span class="s1">&#39;sam&#39;</span> <span class="k">else</span> <span class="s1">&#39;  &#39;</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">code</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">description</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">code</span><span class="p">,</span><span class="n">description</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">parse_codes</span><span class="o">.</span><span class="n">items</span><span class="p">())])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

<span class="k">class</span> <span class="nc">read</span><span class="p">:</span><span id="ecodam_py.pybam.read"></span><a class="mkapi-docs-link" title="ecodam_py.pybam.read" href="../../ecodam_py.pybam/#ecodam_py.pybam.read">DOCS</a>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    [ Dynamic Parser Example ]</span>
<span class="sd">    for alignment in pybam.read(&#39;/my/data.bam&#39;):</span>
<span class="sd">        print alignment.sam_seq</span>

<span class="sd">    [ Static Parser Example ]</span>
<span class="sd">    for seq,mapq in pybam.read(&#39;/my/data.bam&#39;,[&#39;sam_seq&#39;,&#39;sam_mapq&#39;]):</span>
<span class="sd">        print seq</span>
<span class="sd">        print mapq</span>

<span class="sd">    [ Mixed Parser Example ]</span>
<span class="sd">    my_bam = pybam.read(&#39;/my/data.bam&#39;,[&#39;sam_seq&#39;,&#39;sam_mapq&#39;])</span>
<span class="sd">    print my_bam._static_parser_code</span>
<span class="sd">    for seq,mapq in my_bam:</span>
<span class="sd">        if seq.startswith(&#39;ACGT&#39;) and mapq &gt; 10:</span>
<span class="sd">            print my_bam.sam</span>

<span class="sd">    [ Custom Decompressor (from file path) Example ]</span>
<span class="sd">    my_bam = pybam.read(&#39;/my/data.bam.lzma&#39;,decompressor=&#39;lzma --decompress --stdout /my/data.bam.lzma&#39;)</span>

<span class="sd">    [ Custom Decompressor (from file object) Example ]</span>
<span class="sd">    my_bam = pybam.read(sys.stdin,decompressor=&#39;lzma --decompress --stdout&#39;) # data given to lzma via stdin</span>

<span class="sd">    [ Force Internal bgzip Decompressor ]</span>
<span class="sd">    my_bam = pybam.read(&#39;/my/data.bam&#39;,decompressor=&#39;internal&#39;)</span>

<span class="sd">    &quot;print pybam.wat&quot; in the python terminal to see the possible parsable values,</span>
<span class="sd">    or visit http://github.com/JohnLonginotto/pybam for the latest info.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">fields</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">decompressor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_bytes_read</span>         <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_chromosomes</span>        <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_alignments_read</span>    <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_chromosome_lengths</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PybamError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Fields for the static parser must be provided as a non-empty list. You gave a &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">fields</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;sam&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;bam&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parse_codes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="n">PybamError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Static parser field &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot; from fields &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; is not known to this version of pybam!</span><span class="se">\n</span><span class="s1">Print &quot;pybam.wat&quot; to see available field names with explinations.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">PybamError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Static parser field &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot; from fields &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; does not start with &quot;sam&quot; or &quot;bam&quot; and thus is not an avaliable field for the static parsing.</span><span class="se">\n</span><span class="s1">Print &quot;pybam.wat&quot; in interactive python to see available field names with explinations.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">decompressor</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">decompressor</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                 <span class="k">if</span> <span class="n">decompressor</span> <span class="o">!=</span> <span class="s1">&#39;internal&#39;</span> <span class="ow">and</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">decompressor</span><span class="p">:</span> <span class="k">raise</span> <span class="n">PybamError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">When a custom decompressor is used and the input file is a string, the decompressor string must contain at least one occurence of &quot;</span><span class="si">{}</span><span class="s1">&quot; to be substituted with a filepath by pybam.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="n">PybamError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">User-supplied decompressor must be a string that when run on the command line decompresses a named file (or stdin), to stdout:</span><span class="se">\n</span><span class="s1">e.g. &quot;lzma --decompress --stdout </span><span class="si">{}</span><span class="s1">&quot; if pybam is provided a path as input file, where </span><span class="si">{}</span><span class="s1"> is substituted for that path.</span><span class="se">\n</span><span class="s1">or just &quot;lzma --decompress --stdout&quot; if pybam is provided a file object instead of a file path, as data from that file object will be piped via stdin to the decompression program.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1">## First we make a generator that will return chunks of uncompressed data, regardless of how we choose to decompress:</span>
        <span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
            <span class="n">DEVNULL</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>

            <span class="c1"># First we need to figure out what sort of file we have - whether it&#39;s gzip compressed, uncompressed, or something else entirely!</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span> <span class="k">raise</span> <span class="n">PybamError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Could not open &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot; for reading!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">magic</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span><span class="mi">4</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span> <span class="k">raise</span> <span class="n">PybamError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Could not read from &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">is</span> <span class="n">file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="n">f</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">magic</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span><span class="mi">4</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span> <span class="k">raise</span> <span class="n">PybamError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Could not read from &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="n">PybamError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Input file was not a string or a file object. It was: &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">magic</span> <span class="o">==</span> <span class="s1">&#39;BAM</span><span class="se">\1</span><span class="s1">&#39;</span><span class="p">:</span>
                <span class="c1"># The user has passed us already unzipped BAM data! Job done :)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;BAM</span><span class="se">\1</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">35536</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_decompressor</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
                <span class="k">while</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">data</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">35536</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">file_bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">DEVNULL</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span>

            <span class="k">elif</span> <span class="n">magic</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\x1f\x8b\x08\x04</span><span class="s2">&quot;</span><span class="p">:</span>  <span class="c1"># The user has passed us compressed gzip/bgzip data, which is typical for a BAM file</span>
                <span class="c1"># use custom decompressor if provided:</span>
                <span class="k">if</span> <span class="n">decompressor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">decompressor</span> <span class="o">!=</span> <span class="s1">&#39;internal&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>                                    <span class="n">decompressor</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">f</span><span class="p">),</span>    <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>              <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s1">&#39;{ printf &quot;&#39;</span><span class="o">+</span><span class="n">magic</span><span class="o">+</span><span class="s1">&#39;&quot;; cat; } | &#39;</span> <span class="o">+</span> <span class="n">decompressor</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">file_decompressor</span> <span class="o">=</span> <span class="n">decompressor</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">35536</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">file_bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">while</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">data</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">35536</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">file_bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">DEVNULL</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">raise</span> <span class="ne">StopIteration</span>

                <span class="c1"># else look for pigz or gzip:</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;pigz&quot;</span><span class="p">],</span><span class="n">stdin</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">,</span><span class="n">stdout</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">,</span><span class="n">stderr</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                        <span class="n">use</span> <span class="o">=</span> <span class="s1">&#39;pigz&#39;</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;gzip&quot;</span><span class="p">],</span><span class="n">stdin</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">,</span><span class="n">stdout</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">,</span><span class="n">stderr</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                            <span class="n">use</span> <span class="o">=</span> <span class="s1">&#39;gzip&#39;</span>
                        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span> <span class="n">use</span> <span class="o">=</span> <span class="s1">&#39;internal&#39;</span>

                    <span class="k">if</span> <span class="n">use</span> <span class="o">!=</span> <span class="s1">&#39;internal&#39;</span> <span class="ow">and</span> <span class="n">decompressor</span> <span class="o">!=</span> <span class="s1">&#39;internal&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span>                                   <span class="n">use</span> <span class="p">,</span> <span class="s1">&#39;--decompress&#39;</span><span class="p">,</span><span class="s1">&#39;--stdout&#39;</span><span class="p">,</span>       <span class="n">f</span>           <span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>              <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s1">&#39;{ printf &quot;&#39;</span><span class="o">+</span><span class="n">magic</span><span class="o">+</span><span class="s1">&#39;&quot;; cat; } | &#39;</span> <span class="o">+</span> <span class="n">use</span> <span class="o">+</span> <span class="s1">&#39; --decompress  --stdout&#39;</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">)</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">35536</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">file_decompressor</span> <span class="o">=</span> <span class="n">use</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">file_bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                            <span class="k">while</span> <span class="n">data</span><span class="p">:</span>
                                <span class="k">yield</span> <span class="n">data</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">35536</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">file_bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="n">DEVNULL</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="k">raise</span> <span class="ne">StopIteration</span>

                    <span class="c1"># Python&#39;s gzip module can&#39;t read from a stream that doesn&#39;t support seek(), and the zlib module cannot read the bgzip format without a lot of help:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">file_decompressor</span> <span class="o">=</span> <span class="s1">&#39;internal&#39;</span>
                    <span class="n">raw_data</span> <span class="o">=</span> <span class="n">magic</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">65536</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">file_bytes_read</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>
                    <span class="n">internal_cache</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">blocks_left_to_grab</span> <span class="o">=</span> <span class="mi">50</span>
                    <span class="n">bs</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">checkpoint</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">decompress</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span>
                    <span class="k">while</span> <span class="n">raw_data</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span> <span class="o">-</span> <span class="n">bs</span> <span class="o">&lt;</span> <span class="mi">35536</span><span class="p">:</span>
                            <span class="n">raw_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">bs</span><span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">65536</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">file_bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span> <span class="o">-</span> <span class="n">bs</span>
                            <span class="n">bs</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">magic</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">bs</span><span class="p">:</span><span class="n">bs</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">magic</span><span class="p">:</span> <span class="k">break</span> <span class="c1"># a child&#39;s heart</span>
                        <span class="k">if</span> <span class="n">magic</span> <span class="o">!=</span> <span class="s2">&quot;</span><span class="se">\x1f\x8b\x08\x04</span><span class="s2">&quot;</span><span class="p">:</span> <span class="k">raise</span> <span class="n">PybamError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">The input file is not in a format I understand. First four bytes: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">magic</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">more_bs</span> <span class="o">=</span> <span class="n">bs</span> <span class="o">+</span> <span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;H&quot;</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">bs</span><span class="o">+</span><span class="mi">16</span><span class="p">:</span><span class="n">bs</span><span class="o">+</span><span class="mi">18</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span><span class="mi">1</span>
                            <span class="n">internal_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">decompress</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="n">bs</span><span class="o">+</span><span class="mi">18</span><span class="p">:</span><span class="n">more_bs</span><span class="o">-</span><span class="mi">8</span><span class="p">],</span><span class="o">-</span><span class="mi">15</span><span class="p">))</span>
                            <span class="n">bs</span> <span class="o">=</span> <span class="n">more_bs</span>
                        <span class="k">except</span><span class="p">:</span> <span class="c1">## zlib doesnt have a nice exception for when things go wrong. just &quot;error&quot;</span>
                            <span class="n">header_data</span> <span class="o">=</span> <span class="n">magic</span> <span class="o">+</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">bs</span><span class="o">+</span><span class="mi">4</span><span class="p">:</span><span class="n">bs</span><span class="o">+</span><span class="mi">12</span><span class="p">]</span>
                            <span class="n">header_size</span> <span class="o">=</span> <span class="mi">12</span>
                            <span class="n">extra_len</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;H&quot;</span><span class="p">,</span> <span class="n">header_data</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">while</span> <span class="n">header_size</span><span class="o">-</span><span class="mi">12</span> <span class="o">&lt;</span> <span class="n">extra_len</span><span class="p">:</span>
                                <span class="n">header_data</span> <span class="o">+=</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">bs</span><span class="o">+</span><span class="mi">12</span><span class="p">:</span><span class="n">bs</span><span class="o">+</span><span class="mi">16</span><span class="p">]</span>
                                <span class="n">subfield_id</span> <span class="o">=</span> <span class="n">header_data</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                                <span class="n">subfield_len</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;H&quot;</span><span class="p">,</span> <span class="n">header_data</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">subfield_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">bs</span><span class="o">+</span><span class="mi">16</span><span class="p">:</span><span class="n">bs</span><span class="o">+</span><span class="mi">16</span><span class="o">+</span><span class="n">subfield_len</span><span class="p">]</span>
                                <span class="n">header_data</span> <span class="o">+=</span> <span class="n">subfield_data</span>
                                <span class="n">header_size</span> <span class="o">+=</span> <span class="n">subfield_len</span> <span class="o">+</span> <span class="mi">4</span>
                                <span class="k">if</span> <span class="n">subfield_id</span> <span class="o">==</span> <span class="s1">&#39;BC&#39;</span><span class="p">:</span> <span class="n">block_size</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;H&quot;</span><span class="p">,</span> <span class="n">subfield_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">raw_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">bs</span><span class="o">+</span><span class="mi">16</span><span class="o">+</span><span class="n">subfield_len</span><span class="p">:</span><span class="n">bs</span><span class="o">+</span><span class="mi">16</span><span class="o">+</span><span class="n">subfield_len</span><span class="o">+</span><span class="n">block_size</span><span class="o">-</span><span class="n">extra_len</span><span class="o">-</span><span class="mi">19</span><span class="p">]</span>
                            <span class="n">crc_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">bs</span><span class="o">+</span><span class="mi">16</span><span class="o">+</span><span class="n">subfield_len</span><span class="o">+</span><span class="n">block_size</span><span class="o">-</span><span class="n">extra_len</span><span class="o">-</span><span class="mi">19</span><span class="p">:</span><span class="n">bs</span><span class="o">+</span><span class="mi">16</span><span class="o">+</span><span class="n">subfield_len</span><span class="o">+</span><span class="n">block_size</span><span class="o">-</span><span class="n">extra_len</span><span class="o">-</span><span class="mi">19</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span> <span class="c1"># I have left the numbers in verbose, because the above try is the optimised code.</span>
                            <span class="n">bs</span> <span class="o">=</span> <span class="n">bs</span><span class="o">+</span><span class="mi">16</span><span class="o">+</span><span class="n">subfield_len</span><span class="o">+</span><span class="n">block_size</span><span class="o">-</span><span class="n">extra_len</span><span class="o">-</span><span class="mi">19</span><span class="o">+</span><span class="mi">8</span>
                            <span class="n">zipped_data</span> <span class="o">=</span> <span class="n">header_data</span> <span class="o">+</span> <span class="n">raw_data</span> <span class="o">+</span> <span class="n">crc_data</span>
                            <span class="n">internal_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">decompress</span><span class="p">(</span><span class="n">zipped_data</span><span class="p">,</span><span class="mi">47</span><span class="p">))</span> <span class="c1"># 31 works the same as 47.</span>
                            <span class="c1"># Although the following in the bgzip code from biopython, its not needed if you let zlib decompress the whole zipped_data, header and crc, because it checks anyway (in C land)</span>
                            <span class="c1"># I&#39;ve left the manual crc checks in for documentation purposes:</span>
                            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                            expected_crc = crc_data[:4]</span>
<span class="sd">                            expected_size = unpack(&quot;&lt;I&quot;, crc_data[4:])[0]</span>
<span class="sd">                            if len(unzipped_data) != expected_size: print &#39;ERROR: Failed to unpack due to a Type 1 CRC error. Could the BAM be corrupted?&#39;; exit()</span>
<span class="sd">                            crc = zlib.crc32(unzipped_data)</span>
<span class="sd">                            if crc &lt; 0: crc = pack(&quot;&lt;i&quot;, crc)</span>
<span class="sd">                            else:       crc = pack(&quot;&lt;I&quot;, crc)</span>
<span class="sd">                            if expected_crc != crc: print &#39;ERROR: Failed to unpack due to a Type 2 CRC error. Could the BAM be corrupted?&#39;; exit()</span>
<span class="sd">                            &#39;&#39;&#39;</span>
                        <span class="n">blocks_left_to_grab</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">blocks_left_to_grab</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">internal_cache</span><span class="p">)</span>
                            <span class="n">internal_cache</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">blocks_left_to_grab</span> <span class="o">=</span> <span class="mi">50</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">DEVNULL</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">internal_cache</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="k">yield</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">internal_cache</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">StopIteration</span>

            <span class="k">elif</span> <span class="n">decompressor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">decompressor</span> <span class="o">!=</span> <span class="s1">&#39;internal&#39;</span><span class="p">:</span>
                <span class="c1"># It wouldn&#39;t be safe to just print to the shell four random bytes from the beginning of a file, so instead it&#39;s</span>
                <span class="c1"># written to a temp file and cat&#39;d. The idea here being that we trust the decompressor string as it was written by</span>
                <span class="c1"># someone with access to python, so it has system access anyway. The file/data, however, should not be trusted.</span>
                <span class="n">magic_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(),</span><span class="s1">&#39;magic&#39;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">magic_file</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">magic</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>                                      <span class="n">decompressor</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">f</span><span class="p">),</span>    <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>              <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s1">&#39;{ cat &quot;&#39;</span><span class="o">+</span><span class="n">magic_file</span><span class="o">+</span><span class="s1">&#39;&quot;; cat; } | &#39;</span> <span class="o">+</span> <span class="n">decompressor</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_decompressor</span> <span class="o">=</span> <span class="n">decompressor</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">35536</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">file_bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">data</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">35536</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">file_bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">DEVNULL</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PybamError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">The input file is not in a format I understand. First four bytes: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">magic</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1">## At this point, we know that whatever decompression method was used, a call to self._generator will return some uncompressed data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generator</span> <span class="o">=</span> <span class="n">generator</span><span class="p">()</span>

        <span class="c1">## So lets parse the BAM header:</span>
        <span class="n">header_cache</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_cache</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span> <span class="n">header_cache</span> <span class="o">+=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generator</span><span class="p">)</span>

        <span class="n">p_from</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p_to</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">if</span> <span class="n">header_cache</span><span class="p">[</span><span class="n">p_from</span><span class="p">:</span><span class="n">p_to</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;BAM</span><span class="se">\1</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PybamError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Input file &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">+</span> <span class="s1">&#39; does not appear to be a BAM file.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1">## Parse the BAM header:</span>
        <span class="n">p_from</span> <span class="o">=</span> <span class="n">p_to</span><span class="p">;</span> <span class="n">p_to</span> <span class="o">+=</span> <span class="mi">4</span>
        <span class="n">length_of_header</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span><span class="n">header_cache</span><span class="p">[</span><span class="n">p_from</span><span class="p">:</span><span class="n">p_to</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">p_from</span> <span class="o">=</span> <span class="n">p_to</span><span class="p">;</span> <span class="n">p_to</span> <span class="o">+=</span> <span class="n">length_of_header</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_cache</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">p_to</span><span class="p">:</span> <span class="n">header_cache</span> <span class="o">+=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_header</span> <span class="o">=</span> <span class="n">header_cache</span><span class="p">[</span><span class="n">p_from</span><span class="p">:</span><span class="n">p_to</span><span class="p">]</span>
        <span class="n">p_from</span> <span class="o">=</span> <span class="n">p_to</span><span class="p">;</span> <span class="n">p_to</span> <span class="o">+=</span> <span class="mi">4</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_cache</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">p_to</span><span class="p">:</span> <span class="n">header_cache</span> <span class="o">+=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generator</span><span class="p">)</span>
        <span class="n">number_of_reference_sequences</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span><span class="n">header_cache</span><span class="p">[</span><span class="n">p_from</span><span class="p">:</span><span class="n">p_to</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_reference_sequences</span><span class="p">):</span>
            <span class="n">p_from</span> <span class="o">=</span> <span class="n">p_to</span><span class="p">;</span> <span class="n">p_to</span> <span class="o">+=</span> <span class="mi">4</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_cache</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">p_to</span><span class="p">:</span> <span class="n">header_cache</span> <span class="o">+=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generator</span><span class="p">)</span>
            <span class="n">l_name</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;l&#39;</span><span class="p">,</span><span class="n">header_cache</span><span class="p">[</span><span class="n">p_from</span><span class="p">:</span><span class="n">p_to</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">p_from</span> <span class="o">=</span> <span class="n">p_to</span><span class="p">;</span> <span class="n">p_to</span> <span class="o">+=</span> <span class="n">l_name</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_cache</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">p_to</span><span class="p">:</span> <span class="n">header_cache</span> <span class="o">+=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generator</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_chromosomes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header_cache</span><span class="p">[</span><span class="n">p_from</span><span class="p">:</span><span class="n">p_to</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">p_from</span> <span class="o">=</span> <span class="n">p_to</span><span class="p">;</span> <span class="n">p_to</span> <span class="o">+=</span> <span class="mi">4</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_cache</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">p_to</span><span class="p">:</span> <span class="n">header_cache</span> <span class="o">+=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generator</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_chromosome_lengths</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">file_chromosomes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;l&#39;</span><span class="p">,</span><span class="n">header_cache</span><span class="p">[</span><span class="n">p_from</span><span class="p">:</span><span class="n">p_to</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">file_bytes_read</span> <span class="o">=</span> <span class="n">p_to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_binary_header</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">(</span><span class="n">header_cache</span><span class="p">[:</span><span class="n">p_to</span><span class="p">])</span>
        <span class="n">header_cache</span> <span class="o">=</span> <span class="n">header_cache</span><span class="p">[</span><span class="n">p_to</span><span class="p">:]</span>

        <span class="c1"># A quick check to make sure the header of this BAM file makes sense:</span>
        <span class="n">chromosomes_from_header</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@SQ</span><span class="se">\t</span><span class="s1">SN:&#39;</span><span class="p">):</span>
                <span class="n">chromosomes_from_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">:])</span>
        <span class="k">if</span> <span class="n">chromosomes_from_header</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_chromosomes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PybamWarn</span><span class="p">(</span><span class="s1">&#39;For some reason the BAM format stores the chromosome names in two locations,</span><span class="se">\n</span><span class="s1">       the ASCII text header we all know and love, viewable with samtools view -H, and another special binary header</span><span class="se">\n</span><span class="s1">       which is used to translate the chromosome refID (a number) into a chromosome RNAME when you do bam -&gt; sam.</span><span class="se">\n\n</span><span class="s1">These two headers should always be the same, but apparently they are not:</span><span class="se">\n</span><span class="s1">The ASCII header looks like: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_header</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">While the binary header has the following chromosomes: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_chromosomes</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1">## Variable parsing:</span>
        <span class="k">def</span> <span class="nf">new_entry</span><span class="p">(</span><span class="n">header_cache</span><span class="p">):</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="n">header_cache</span> <span class="c1"># we keep a small cache of X bytes of decompressed BAM data, to smoothen out disk access.</span>
            <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># where the next alignment/entry starts in the cache</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">4</span><span class="p">:</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">p</span><span class="p">:]</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generator</span><span class="p">);</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Grab enough bytes to parse blocksize</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sam_block_size</span>  <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span><span class="n">cache</span><span class="p">[</span><span class="n">p</span><span class="p">:</span><span class="n">p</span><span class="o">+</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">file_alignments_read</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sam_block_size</span><span class="p">:</span>
                        <span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">p</span><span class="p">:]</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generator</span><span class="p">);</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Grab enough bytes to parse entry</span>
                <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span> <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bam</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">p</span><span class="p">:</span><span class="n">p</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sam_block_size</span><span class="p">]</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sam_block_size</span>
                <span class="k">yield</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_entry</span> <span class="o">=</span> <span class="n">new_entry</span><span class="p">(</span><span class="n">header_cache</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">compile_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fields</span><span class="p">):</span>
            <span class="n">temp_code</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">end_of_qname</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">end_of_cigar</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">end_of_seq</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">end_of_qual</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">dependencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;bam&#39;</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">fields</span><span class="p">[</span><span class="n">fields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;bam&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;self.bam&#39;</span>

            <span class="k">if</span> <span class="s1">&#39;sam_block_size&#39;</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">fields</span><span class="p">[</span><span class="n">fields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;sam_block_size&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;self.sam_block_size&#39;</span>

            <span class="k">if</span> <span class="s1">&#39;sam&#39;</span>                  <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="s1">&#39;sam_qname&#39;</span><span class="p">,</span><span class="s1">&#39;sam_flag&#39;</span><span class="p">,</span><span class="s1">&#39;sam_rname&#39;</span><span class="p">,</span><span class="s1">&#39;sam_pos1&#39;</span><span class="p">,</span><span class="s1">&#39;sam_mapq&#39;</span><span class="p">,</span><span class="s1">&#39;sam_cigar_string&#39;</span><span class="p">,</span><span class="s1">&#39;bam_refID&#39;</span><span class="p">,</span><span class="s1">&#39;bam_next_refID&#39;</span><span class="p">,</span><span class="s1">&#39;sam_rnext&#39;</span><span class="p">,</span><span class="s1">&#39;sam_pnext1&#39;</span><span class="p">,</span><span class="s1">&#39;sam_tlen&#39;</span><span class="p">,</span><span class="s1">&#39;sam_seq&#39;</span><span class="p">,</span><span class="s1">&#39;sam_qual&#39;</span><span class="p">,</span><span class="s1">&#39;sam_tags_string&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="s1">&#39;sam_tags_string&#39;</span>      <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="s1">&#39;sam_tags_list&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="s1">&#39;sam_pos1&#39;</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="n">temp_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        sam_pos1 = (0 if sam_pos0 &lt; 0 else sam_pos0 + 1)&quot;</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="s1">&#39;sam_pos0&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="s1">&#39;sam_pnext1&#39;</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="n">temp_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        sam_pnext1 = (0 if sam_pnext0 &lt; 0 else sam_pnext0 + 1)&quot;</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="s1">&#39;sam_pnext0&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="s1">&#39;sam_qname&#39;</span> <span class="ow">in</span> <span class="n">dependencies</span> <span class="ow">or</span> <span class="s1">&#39;bam_qname&#39;</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="n">temp_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        _end_of_qname = 36 + sam_l_read_name&quot;</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="s1">&#39;sam_l_read_name&#39;</span><span class="p">])</span>
                <span class="n">end_of_qname</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="s1">&#39;sam_cigar_string&#39;</span> <span class="ow">in</span> <span class="n">dependencies</span> <span class="ow">or</span> <span class="s1">&#39;sam_cigar_list&#39;</span> <span class="ow">in</span> <span class="n">dependencies</span> <span class="ow">or</span> <span class="s1">&#39;bam_cigar&#39;</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">end_of_qname</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">temp_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        _end_of_qname = 36 + sam_l_read_name&quot;</span>
                <span class="n">temp_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        _end_of_cigar = _end_of_qname + (4*sam_n_cigar_op)&quot;</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="s1">&#39;sam_l_read_name&#39;</span><span class="p">,</span><span class="s1">&#39;sam_n_cigar_op&#39;</span><span class="p">])</span>
                <span class="n">end_of_cigar</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="s1">&#39;sam_seq&#39;</span> <span class="ow">in</span> <span class="n">dependencies</span> <span class="ow">or</span> <span class="s1">&#39;bam_seq&#39;</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">end_of_cigar</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">end_of_qname</span><span class="p">:</span>
                    <span class="n">temp_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        _end_of_cigar = _end_of_qname + (4*sam_n_cigar_op)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">temp_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        _end_of_cigar = 36 + sam_l_read_name + (4*sam_n_cigar_op)&quot;</span>
                <span class="n">temp_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        _end_of_seq = _end_of_cigar + (-((-sam_l_seq)//2))&quot;</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="s1">&#39;sam_l_seq&#39;</span><span class="p">,</span><span class="s1">&#39;sam_n_cigar_op&#39;</span><span class="p">,</span><span class="s1">&#39;sam_l_read_name&#39;</span><span class="p">])</span>
                <span class="n">end_of_seq</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="s1">&#39;sam_qual&#39;</span> <span class="ow">in</span> <span class="n">dependencies</span> <span class="ow">or</span> <span class="s1">&#39;bam_qual&#39;</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">end_of_seq</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">end_of_cigar</span><span class="p">:</span>
                    <span class="n">temp_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        _end_of_seq   = _end_of_cigar + (-((-sam_l_seq)//2))&quot;</span>
                <span class="k">elif</span> <span class="n">end_of_qname</span><span class="p">:</span>
                    <span class="n">temp_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        _end_of_seq   = _end_of_qname + (4*sam_n_cigar_op) + (-((-sam_l_seq)//2))&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">temp_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        _end_of_seq   = 36 + sam_l_read_name + (4*sam_n_cigar_op) + (-((-sam_l_seq)//2))&quot;</span>
                <span class="n">temp_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        _end_of_qual = _end_of_seq + sam_l_seq&quot;</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="s1">&#39;sam_l_seq&#39;</span><span class="p">,</span><span class="s1">&#39;sam_n_cigar_op&#39;</span><span class="p">,</span><span class="s1">&#39;sam_l_read_name&#39;</span><span class="p">])</span>
                <span class="n">end_of_qual</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="s1">&#39;sam_tags_list&#39;</span> <span class="ow">in</span> <span class="n">dependencies</span> <span class="ow">or</span> <span class="s1">&#39;bam_tags&#39;</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">end_of_qual</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">end_of_seq</span><span class="p">:</span>
                    <span class="n">temp_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        _end_of_qual = _end_of_seq + sam_l_seq&quot;</span>
                <span class="k">elif</span> <span class="n">end_of_cigar</span><span class="p">:</span>
                    <span class="n">temp_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        _end_of_qual = _end_of_cigar + (-((-sam_l_seq)//2)) + sam_l_seq&quot;</span>
                <span class="k">elif</span> <span class="n">end_of_qname</span><span class="p">:</span>
                    <span class="n">temp_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        _end_of_qual = _end_of_qname + (4*sam_n_cigar_op) + (-((-sam_l_seq)//2)) + sam_l_seq&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">temp_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        _end_of_qual = 36 + sam_l_read_name + (4*sam_n_cigar_op) + (-((-sam_l_seq)//2)) + sam_l_seq&quot;</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="s1">&#39;sam_l_seq&#39;</span><span class="p">,</span><span class="s1">&#39;sam_n_cigar_op&#39;</span><span class="p">,</span><span class="s1">&#39;sam_l_read_name&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="s1">&#39;sam_rname&#39;</span>       <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="n">temp_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        sam_rname = &#39;*&#39; if sam_refID &lt; 0 else self.file_chromosomes[sam_refID]&quot;</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="s1">&#39;sam_refID&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="s1">&#39;sam_rnext&#39;</span>       <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="n">temp_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        sam_rnext = &#39;*&#39; if sam_next_refID &lt; 0 else self.file_chromosomes[sam_next_refID]&quot;</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="s1">&#39;sam_next_refID&#39;</span><span class="p">])</span>

            <span class="c1">## First we figure out what data from the static portion of the BAM entry we&#39;ll need:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;def parser(self):</span><span class="se">\n</span><span class="s1">    from array import array</span><span class="se">\n</span><span class="s1">    from struct import unpack</span><span class="se">\n</span><span class="s1">    for _ in self._new_entry:&#39;</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;last_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;name_list&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">[]</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;dtype_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">def</span> <span class="nf">pack_up</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">dtype</span><span class="p">,</span><span class="n">length</span><span class="p">,</span><span class="n">end</span><span class="p">,</span><span class="n">tmp</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;last_start&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;last_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">length</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;name_list&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;dtype_list&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;last_start&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">        &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;name_list&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; = unpack(&quot;&lt;&#39;</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;dtype_list&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;&quot;,self.bam[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;last_start&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;])&#39;</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;dtype_list&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;[0]&#39;</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;last_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;name_list&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;dtype_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">pack_up</span><span class="p">(</span><span class="s1">&#39;sam_refID&#39;</span><span class="p">,</span>       <span class="s1">&#39;i&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">pack_up</span><span class="p">(</span><span class="s1">&#39;sam_pos0&#39;</span><span class="p">,</span>        <span class="s1">&#39;i&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">pack_up</span><span class="p">(</span><span class="s1">&#39;sam_l_read_name&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">pack_up</span><span class="p">(</span><span class="s1">&#39;sam_mapq&#39;</span><span class="p">,</span>        <span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">pack_up</span><span class="p">(</span><span class="s1">&#39;sam_bin&#39;</span><span class="p">,</span>         <span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">pack_up</span><span class="p">(</span><span class="s1">&#39;sam_n_cigar_op&#39;</span><span class="p">,</span>  <span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">pack_up</span><span class="p">(</span><span class="s1">&#39;sam_flag&#39;</span><span class="p">,</span>        <span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">pack_up</span><span class="p">(</span><span class="s1">&#39;sam_l_seq&#39;</span><span class="p">,</span>       <span class="s1">&#39;i&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">pack_up</span><span class="p">(</span><span class="s1">&#39;sam_next_refID&#39;</span><span class="p">,</span>  <span class="s1">&#39;i&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">pack_up</span><span class="p">(</span><span class="s1">&#39;sam_pnext0&#39;</span><span class="p">,</span>      <span class="s1">&#39;i&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">pack_up</span><span class="p">(</span><span class="s1">&#39;sam_tlen&#39;</span><span class="p">,</span>        <span class="s1">&#39;i&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">pack_up</span><span class="p">(</span> <span class="kc">None</span><span class="p">,</span>            <span class="kc">None</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="n">tmp</span><span class="p">)</span> <span class="c1"># To add anything not yet added.</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">tmp</span>

            <span class="n">code</span> <span class="o">+=</span> <span class="n">temp_code</span>

            <span class="c1"># Fixed-length BAM data (where we just grab the bytes, we dont unpack) can, however, be grabbed individually.</span>
            <span class="k">if</span> <span class="s1">&#39;bam_block_size&#39;</span>  <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        bam_block_size   = self.bam[0             : 4                ]&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;bam_refID&#39;</span>       <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        bam_refID        = self.bam[4             : 8                ]&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;bam_pos&#39;</span>         <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        bam_pos          = self.bam[8             : 12               ]&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;bam_l_read_name&#39;</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        bam_l_read_name  = self.bam[12            : 13               ]&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;bam_mapq&#39;</span>        <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        bam_mapq         = self.bam[13            : 14               ]&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;bam_bin&#39;</span>         <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        bam_bin          = self.bam[14            : 16               ]&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;bam_n_cigar_op&#39;</span>  <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        bam_n_cigar_op   = self.bam[16            : 18               ]&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;bam_flag&#39;</span>        <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        bam_flag         = self.bam[18            : 20               ]&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;bam_l_seq&#39;</span>       <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        bam_l_seq        = self.bam[20            : 24               ]&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;bam_next_refID&#39;</span>  <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        bam_next_refID   = self.bam[24            : 28               ]&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;bam_pnext&#39;</span>       <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        bam_pnext        = self.bam[28            : 32               ]&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;bam_tlen&#39;</span>        <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        bam_tlen         = self.bam[32            : 36               ]&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;bam_qname&#39;</span>       <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        bam_qname        = self.bam[36            : _end_of_qname    ]&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;bam_cigar&#39;</span>       <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        bam_cigar        = self.bam[_end_of_qname : _end_of_cigar    ]&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;bam_seq&#39;</span>         <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        bam_seq          = self.bam[_end_of_cigar : _end_of_seq      ]&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;bam_qual&#39;</span>        <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        bam_qual         = self.bam[_end_of_seq   : _end_of_qual     ]&quot;</span>
            <span class="k">if</span> <span class="s1">&#39;bam_tags&#39;</span>        <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        bam_tags         = self.bam[_end_of_qual  :                  ]&quot;</span>

            <span class="k">if</span> <span class="s1">&#39;sam_qname&#39;</span>       <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;bam_qname&#39;</span>   <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        sam_qname        = bam_qname[:-1]&quot;</span>
                <span class="k">else</span><span class="p">:</span>                             <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        sam_qname        = self.bam[36            : _end_of_qname -1 ]&quot;</span>

            <span class="k">if</span> <span class="s1">&#39;sam_cigar_list&#39;</span>  <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;bam_cigar&#39;</span>   <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        sam_cigar_list = [( cig &gt;&gt; 4  , cigar_codes[cig &amp; 0b1111]) for cig in array(&#39;I&#39;, bam_cigar) ]&quot;</span>
                <span class="k">else</span><span class="p">:</span>                             <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        sam_cigar_list = [( cig &gt;&gt; 4  , cigar_codes[cig &amp; 0b1111]) for cig in array(&#39;I&#39;, self.bam[_end_of_qname : _end_of_cigar]) ]&quot;</span>

            <span class="k">if</span> <span class="s1">&#39;sam_cigar_string&#39;</span><span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;bam_cigar&#39;</span>   <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        sam_cigar_string = &#39;&#39;.join([        str(cig &gt;&gt; 4) + cigar_codes[cig &amp; 0b1111] for cig     in array(&#39;I&#39;, bam_cigar)])&quot;</span>
                <span class="k">else</span><span class="p">:</span>                             <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        sam_cigar_string = &#39;&#39;.join([        str(cig &gt;&gt; 4) + cigar_codes[cig &amp; 0b1111] for cig     in array(&#39;I&#39;, self.bam[_end_of_qname : _end_of_cigar]) ])&quot;</span>

            <span class="k">if</span> <span class="s1">&#39;sam_seq&#39;</span>         <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;bam_seq&#39;</span>     <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        sam_seq = &#39;&#39;.join( [ dna_codes[dna &gt;&gt; 4] + dna_codes[dna &amp; 0b1111]   for dna     in array(&#39;B&#39;, bam_seq)])[:sam_l_seq]&quot;</span>
                <span class="k">else</span><span class="p">:</span>                             <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        sam_seq = &#39;&#39;.join( [ dna_codes[dna &gt;&gt; 4] + dna_codes[dna &amp; 0b1111]   for dna     in array(&#39;B&#39;, self.bam[_end_of_cigar : _end_of_seq])])[:sam_l_seq]&quot;</span>

            <span class="k">if</span> <span class="s1">&#39;sam_qual&#39;</span>        <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;bam_qual&#39;</span>    <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span> <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        sam_qual = &#39;&#39;.join( [                   chr(ord(quality) + 33)        for quality in            bam_qual ])&quot;</span>
                <span class="k">else</span><span class="p">:</span>                             <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        sam_qual = &#39;&#39;.join( [                   chr(ord(quality) + 33)        for quality in            self.bam[_end_of_seq       : _end_of_qual  ]])&quot;</span>

            <span class="k">if</span> <span class="s1">&#39;sam_tags_list&#39;</span>        <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">+=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        sam_tags_list = []</span>
<span class="s1">        offset = _end_of_qual</span>
<span class="s1">        while offset != len(self.bam):</span>
<span class="s1">            tag_name = self.bam[offset:offset+2]</span>
<span class="s1">            tag_type = self.bam[offset+2]</span>
<span class="s1">            if tag_type == &#39;Z&#39;:</span>
<span class="s1">                offset_end = self.bam.index(&#39;</span><span class="se">\\</span><span class="s1">0&#39;,offset+3)+1</span>
<span class="s1">                tag_data = self.bam[offset+3:offset_end-1]</span>
<span class="s1">            elif tag_type in CtoPy:</span>
<span class="s1">                offset_end = offset+3+py4py[tag_type]</span>
<span class="s1">                tag_data = unpack(CtoPy[tag_type],self.bam[offset+3:offset_end])[0]</span>
<span class="s1">            elif tag_type == &#39;B&#39;:</span>
<span class="s1">                offset_end = offset+8+(unpack(&#39;&lt;i&#39;,self.bam[offset+4:offset+8])[0]*py4py[self.bam[offset+3]])</span>
<span class="s1">                tag_data = array(self.bam[offset+3] , self.bam[offset+8:offset_end] )</span>
<span class="s1">            else:</span>
<span class="s1">                print &#39;PYBAM ERROR: I dont know how to parse BAM tags in this format: &#39;,repr(tag_type)</span>
<span class="s1">                print &#39;             This is simply because I never saw this kind of tag during development.&#39;</span>
<span class="s1">                print &#39;             If you could mail the following chunk of text to john at john.uk.com, i will fix this up for everyone :)&#39;</span>
<span class="s1">                print repr(tag_type),repr(self.bam[offset+3:end])</span>
<span class="s1">                exit()</span>
<span class="s1">            sam_tags_list.append((tag_name,tag_type,tag_data))</span>
<span class="s1">            offset = offset_end&#39;&#39;&#39;</span>

            <span class="k">if</span> <span class="s1">&#39;sam_tags_string&#39;</span>      <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        sam_tags_string = &#39;</span><span class="se">\t</span><span class="s2">&#39;.join(A + &#39;:&#39; + (&#39;i&#39; if B in &#39;cCsSI&#39; else B)  + &#39;:&#39; + ((C.typecode + &#39;,&#39; + &#39;,&#39;.join(map(str,C))) if type(C)==array else str(C)) for A,B,C in self.sam_tags_list)&quot;</span>

            <span class="k">if</span> <span class="s1">&#39;sam&#39;</span>                  <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        sam = sam_qname + &#39;</span><span class="se">\t</span><span class="s2">&#39; + str(sam_flag) + &#39;</span><span class="se">\t</span><span class="s2">&#39; + sam_rname + &#39;</span><span class="se">\t</span><span class="s2">&#39; + str(sam_pos1) + &#39;</span><span class="se">\t</span><span class="s2">&#39; + str(sam_mapq) + &#39;</span><span class="se">\t</span><span class="s2">&#39; + (&#39;*&#39; if sam_cigar_string == &#39;&#39; else sam_cigar_string) + &#39;</span><span class="se">\t</span><span class="s2">&#39; + (&#39;=&#39; if bam_refID == bam_next_refID else sam_rnext) + &#39;</span><span class="se">\t</span><span class="s2">&#39; + str(sam_pnext1) + &#39;</span><span class="se">\t</span><span class="s2">&#39; + str(sam_tlen) + &#39;</span><span class="se">\t</span><span class="s2">&#39; + sam_seq + &#39;</span><span class="se">\t</span><span class="s2">&#39; + sam_qual + &#39;</span><span class="se">\t</span><span class="s2">&#39; + sam_tags_string&quot;</span>

            <span class="n">code</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">        yield &#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_static_parser_code</span> <span class="o">=</span> <span class="n">code</span> <span class="c1"># &quot;code&quot; is the static parser&#39;s code as a string (a function called &quot;parser&quot;)</span>
            <span class="n">exec_dict</span> <span class="o">=</span> <span class="p">{</span>                   <span class="c1"># This dictionary stores things the exec&#39;d code needs to know about, and will store the compiled function after exec()</span>
                <span class="s1">&#39;unpack&#39;</span><span class="p">:</span><span class="n">unpack</span><span class="p">,</span>
                <span class="s1">&#39;array&#39;</span><span class="p">:</span><span class="n">array</span><span class="p">,</span>
                <span class="s1">&#39;dna_codes&#39;</span><span class="p">:</span><span class="n">dna_codes</span><span class="p">,</span>
                <span class="s1">&#39;CtoPy&#39;</span><span class="p">:</span><span class="n">CtoPy</span><span class="p">,</span>
                <span class="s1">&#39;py4py&#39;</span><span class="p">:</span><span class="n">py4py</span><span class="p">,</span>
                <span class="s1">&#39;cigar_codes&#39;</span><span class="p">:</span><span class="n">cigar_codes</span>
            <span class="p">}</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">code</span> <span class="ow">in</span> <span class="n">exec_dict</span><span class="p">)</span>            <span class="c1"># exec() compiles &quot;code&quot; to real code, creating the &quot;parser&quot; function and adding it to exec_dict[&#39;parser&#39;]</span>
            <span class="k">return</span> <span class="n">exec_dict</span><span class="p">[</span><span class="s1">&#39;parser&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">static_parser</span> <span class="o">=</span> <span class="n">compile_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fields</span><span class="p">)(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">next_read</span><span class="p">():</span> <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">static_parser</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">next_read</span><span class="p">():</span> <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new_entry</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">next_read</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sam</span>

    <span class="c1">## Methods to pull out raw bam data from entry (so still in its binary encoding). This can be helpful in some scenarios.</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bam_block_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>   <span class="k">return</span>               <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span>                        <span class="p">:</span> <span class="mi">4</span>                         <span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bam_refID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">return</span>               <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">4</span>                      <span class="p">:</span> <span class="mi">8</span>                         <span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bam_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>          <span class="k">return</span>               <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">8</span>                      <span class="p">:</span> <span class="mi">12</span>                        <span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bam_l_read_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="k">return</span>               <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">12</span>                     <span class="p">:</span> <span class="mi">13</span>                        <span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bam_mapq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>         <span class="k">return</span>               <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">13</span>                     <span class="p">:</span> <span class="mi">14</span>                        <span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bam_bin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>          <span class="k">return</span>               <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">14</span>                     <span class="p">:</span> <span class="mi">16</span>                        <span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bam_n_cigar_op</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>   <span class="k">return</span>               <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">16</span>                     <span class="p">:</span> <span class="mi">18</span>                        <span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bam_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>         <span class="k">return</span>               <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">18</span>                     <span class="p">:</span> <span class="mi">20</span>                        <span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bam_l_seq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">return</span>               <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">20</span>                     <span class="p">:</span> <span class="mi">24</span>                        <span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bam_next_refID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>   <span class="k">return</span>               <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">24</span>                     <span class="p">:</span> <span class="mi">28</span>                        <span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bam_pnext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">return</span>               <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">28</span>                     <span class="p">:</span> <span class="mi">32</span>                        <span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bam_tlen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>         <span class="k">return</span>               <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">32</span>                     <span class="p">:</span> <span class="mi">36</span>                        <span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bam_qname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">return</span>               <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">36</span>                     <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_of_qname</span>        <span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bam_cigar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">return</span>               <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_of_qname</span>     <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_of_cigar</span>        <span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bam_seq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>          <span class="k">return</span>               <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_of_cigar</span>     <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_of_seq</span>          <span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bam_qual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>         <span class="k">return</span>               <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_of_seq</span>       <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_of_qual</span>         <span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bam_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>         <span class="k">return</span>               <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_of_qual</span>      <span class="p">:</span>                           <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_refID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">return</span> <span class="n">unpack</span><span class="p">(</span> <span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">4</span>                      <span class="p">:</span>  <span class="mi">8</span>                        <span class="p">]</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_pos0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>         <span class="k">return</span> <span class="n">unpack</span><span class="p">(</span> <span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">8</span>                      <span class="p">:</span> <span class="mi">12</span>                        <span class="p">]</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_l_read_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="k">return</span> <span class="n">unpack</span><span class="p">(</span> <span class="s1">&#39;&lt;B&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">12</span>                     <span class="p">:</span> <span class="mi">13</span>                        <span class="p">]</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_mapq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>         <span class="k">return</span> <span class="n">unpack</span><span class="p">(</span> <span class="s1">&#39;&lt;B&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">13</span>                     <span class="p">:</span> <span class="mi">14</span>                        <span class="p">]</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_bin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>          <span class="k">return</span> <span class="n">unpack</span><span class="p">(</span> <span class="s1">&#39;&lt;H&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">14</span>                     <span class="p">:</span> <span class="mi">16</span>                        <span class="p">]</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_n_cigar_op</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>   <span class="k">return</span> <span class="n">unpack</span><span class="p">(</span> <span class="s1">&#39;&lt;H&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">16</span>                     <span class="p">:</span> <span class="mi">18</span>                        <span class="p">]</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>         <span class="k">return</span> <span class="n">unpack</span><span class="p">(</span> <span class="s1">&#39;&lt;H&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">18</span>                     <span class="p">:</span> <span class="mi">20</span>                        <span class="p">]</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_l_seq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">return</span> <span class="n">unpack</span><span class="p">(</span> <span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">20</span>                     <span class="p">:</span> <span class="mi">24</span>                        <span class="p">]</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_next_refID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>   <span class="k">return</span> <span class="n">unpack</span><span class="p">(</span> <span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">24</span>                     <span class="p">:</span> <span class="mi">28</span>                        <span class="p">]</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_pnext0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>       <span class="k">return</span> <span class="n">unpack</span><span class="p">(</span> <span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">28</span>                     <span class="p">:</span> <span class="mi">32</span>                        <span class="p">]</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_tlen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>         <span class="k">return</span> <span class="n">unpack</span><span class="p">(</span> <span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">32</span>                     <span class="p">:</span> <span class="mi">36</span>                        <span class="p">]</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_qname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">return</span>               <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span> <span class="mi">36</span>                     <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_of_qname</span> <span class="o">-</span><span class="mi">1</span>     <span class="p">]</span> <span class="c1"># -1 to remove trailing NUL byte</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_cigar_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>   <span class="k">return</span>          <span class="p">[</span>          <span class="p">(</span><span class="n">cig</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span>  <span class="p">,</span> <span class="n">cigar_codes</span><span class="p">[</span><span class="n">cig</span> <span class="o">&amp;</span> <span class="mb">0b1111</span><span class="p">]</span> <span class="p">)</span> <span class="k">for</span> <span class="n">cig</span>     <span class="ow">in</span> <span class="n">array</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_end_of_qname</span>     <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_of_cigar</span> <span class="p">])]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_cigar_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="p">[</span>       <span class="nb">str</span><span class="p">(</span><span class="n">cig</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">cigar_codes</span><span class="p">[</span><span class="n">cig</span> <span class="o">&amp;</span> <span class="mb">0b1111</span><span class="p">]</span>   <span class="k">for</span> <span class="n">cig</span>     <span class="ow">in</span> <span class="n">array</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_end_of_qname</span>     <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_of_cigar</span> <span class="p">])])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_seq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>          <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="p">[</span> <span class="n">dna_codes</span><span class="p">[</span><span class="n">dna</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+</span>   <span class="n">dna_codes</span><span class="p">[</span><span class="n">dna</span> <span class="o">&amp;</span> <span class="mb">0b1111</span><span class="p">]</span>   <span class="k">for</span> <span class="n">dna</span>     <span class="ow">in</span> <span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_end_of_cigar</span>     <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_of_seq</span>   <span class="p">])])[:</span><span class="bp">self</span><span class="o">.</span><span class="n">sam_l_seq</span><span class="p">]</span> <span class="c1"># As DNA is 4 bits packed 2-per-byte, there might be a trailing &#39;0000&#39;, so we can either</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_qual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>         <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="p">[</span>                      <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">quality</span><span class="p">)</span> <span class="o">+</span> <span class="mi">33</span><span class="p">)</span>       <span class="k">for</span> <span class="n">quality</span> <span class="ow">in</span>            <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_end_of_seq</span>       <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_of_qual</span>  <span class="p">]])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_tags_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_of_qual</span>
        <span class="k">while</span> <span class="n">offset</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">):</span>
            <span class="n">tag_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">tag_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tag_type</span> <span class="o">==</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span>
                <span class="n">offset_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">tag_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="p">:</span><span class="n">offset_end</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">tag_type</span> <span class="ow">in</span> <span class="n">CtoPy</span><span class="p">:</span>
                <span class="n">offset_end</span> <span class="o">=</span> <span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="o">+</span><span class="n">py4py</span><span class="p">[</span><span class="n">tag_type</span><span class="p">]</span>
                <span class="n">tag_data</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">CtoPy</span><span class="p">[</span><span class="n">tag_type</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="p">:</span><span class="n">offset_end</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">tag_type</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span>
                <span class="n">offset_end</span> <span class="o">=</span> <span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="p">(</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;i&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">4</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">py4py</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="p">]])</span>
                <span class="n">tag_data</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">8</span><span class="p">:</span><span class="n">offset_end</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PYBAM ERROR: I dont know how to parse BAM tags in this format: &#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">tag_type</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;             This is simply because I never saw this kind of tag during development.&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;             If you could mail the following chunk of text to john at john.uk.com, ill fix this up :)&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">tag_type</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bam</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="mi">3</span><span class="p">:</span><span class="n">end</span><span class="p">]))</span>
                <span class="n">exit</span><span class="p">()</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tag_name</span><span class="p">,</span><span class="n">tag_type</span><span class="p">,</span><span class="n">tag_data</span><span class="p">))</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">offset_end</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_tags_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">A</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;i&#39;</span> <span class="k">if</span> <span class="n">B</span> <span class="ow">in</span> <span class="s1">&#39;cCsSI&#39;</span> <span class="k">else</span> <span class="n">B</span><span class="p">)</span>  <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="p">((</span><span class="n">C</span><span class="o">.</span><span class="n">typecode</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">C</span><span class="p">)))</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">C</span><span class="p">)</span><span class="o">==</span><span class="n">array</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">C</span><span class="p">))</span> <span class="k">for</span> <span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sam_tags_list</span><span class="p">)</span>

    <span class="c1">## BONUS methods - methods that mimic how samtools works.</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_pos1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>         <span class="k">return</span>  <span class="mi">0</span>  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sam_pos0</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sam_pos0</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_pnext1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>       <span class="k">return</span>  <span class="mi">0</span>  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sam_pnext0</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sam_pnext0</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_rname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">return</span> <span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sam_refID</span>      <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_chromosomes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sam_refID</span>     <span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam_rnext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="k">return</span> <span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sam_next_refID</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_chromosomes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sam_next_refID</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>              <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sam_qname</span>                                                     <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sam_flag</span><span class="p">)</span>                                                 <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sam_rname</span>                                                     <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sam_pos1</span><span class="p">)</span>                                                 <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sam_mapq</span><span class="p">)</span>                                                 <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span>
            <span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sam_cigar_string</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sam_cigar_string</span><span class="p">)</span>    <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span>
            <span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam_refID</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bam_next_refID</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">sam_rnext</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sam_pnext1</span><span class="p">)</span>                                               <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sam_tlen</span><span class="p">)</span>                                                 <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sam_seq</span>                                                       <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sam_qual</span>                                                      <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sam_tags_string</span>
        <span class="p">)</span>

    <span class="c1">## Internal methods - methods used to calculate where variable-length blocks start/end</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_end_of_qname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sam_l_read_name</span>   <span class="o">+</span> <span class="mi">36</span>                        <span class="c1"># fixed-length stuff at the beginning takes up 36 bytes.</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_end_of_cigar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_of_qname</span>     <span class="o">+</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sam_n_cigar_op</span><span class="p">)</span>   <span class="c1"># 4 bytes per n_cigar_op</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_end_of_seq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_of_cigar</span>     <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">sam_l_seq</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># {blurgh}</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_end_of_qual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_of_seq</span>       <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sam_l_seq</span>            <span class="c1"># qual has the same length as seq</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">PybamWarn</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span><span id="ecodam_py.pybam.PybamWarn"></span><a class="mkapi-docs-link" title="ecodam_py.pybam.PybamWarn" href="../../ecodam_py.pybam/#ecodam_py.pybam.PybamWarn">DOCS</a>
<span class="k">class</span> <span class="nc">PybamError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span><span id="ecodam_py.pybam.PybamError"></span><a class="mkapi-docs-link" title="ecodam_py.pybam.PybamError" href="../../ecodam_py.pybam/#ecodam_py.pybam.PybamError">DOCS</a>
</code></pre></div>
</div>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../js/mkapi.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
